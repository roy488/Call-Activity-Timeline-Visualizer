<script>
    // ---------- Constants ----------
    const WORKING_DAY_SECONDS = 8 * 60 * 60;
    const IDLE_TIME_HIGHLIGHT_THRESHOLD = 30 * 60;
    const SHEET_NAME_TO_FIND = "Users";
    const AGENT_DATA_START_KEYWORD = "Name";

    // FIX: Replaced fixed indices with dynamic required headers.
    const REQUIRED_HEADERS = [
      "Name",
      "User Status",
      "Total Calls",
      "# Inbound",
      "# Outbound",
      "Total Handle Time (in)",
      "Total Handle Time (out)"
    ];

    // ---------- State ----------
    let initialData = [];
    let agentsAvailableInFile = [];
    let agentsToDisplay = [];
    let totalReportDays = 0;
    let agentStatistics = [];
    let sortColumn = 'agentName';
    let sortDirection = 'asc';

    // ---------- UI refs ----------
    const dropArea = document.getElementById('drop-area');
    const dataFileInput = document.getElementById('dataFileInput');
    const dropText = document.getElementById('drop-text');
    const statusMessage = document.getElementById('status-message');

    // ---------- Utils ----------
    const hmsToSeconds = (hms) => {
      if (!hms || typeof hms !== 'string') return 0;
      const parts = hms.split(':');
      if (parts.length === 3) {
        const h = parseInt(parts[0], 10) || 0;
        const m = parseInt(parts[1], 10) || 0;
        const s = parseInt(parts[2], 10) || 0;
        return (h * 3600) + (m * 60) + s;
      }
      return 0;
    };

    const secondsToHms = (d) => {
      d = Math.round(Number(d));
      const h = Math.floor(d / 3600);
      const m = Math.floor((d % 3600) / 60);
      const s = d % 60;
      const hDisplay = h > 0 ? `${h}h ` : "";
      const mDisplay = m > 0 ? `${m}m ` : "";
      const sDisplay = s > 0 || (h === 0 && m === 0) ? `${s}s` : "";
      return (hDisplay + mDisplay + sDisplay).trim() || '0s';
    };

    // ---------- ZIP normalizer (fixes data-descriptor XLSX errors) - Kept as is ----------
    function normalizeZipLocalHeaders(u8) {
      const SIG_EOCD = 0x06054b50;   // End of central directory
      const SIG_CEN  = 0x02014b50;   // Central directory file header
      const SIG_LOC  = 0x04034b50;   // Local file header

      const dv = new DataView(u8.buffer, u8.byteOffset, u8.byteLength);
      const maxBack = Math.min(u8.length, 0x10000 + 22);
      let eocdPos = -1;
      for (let i = u8.length - 22; i >= u8.length - maxBack; --i) {
        if (i < 0) break;
        if (dv.getUint32(i, true) === SIG_EOCD) { eocdPos = i; break; }
      }
      if (eocdPos < 0) return u8;

      const cenSize = dv.getUint32(eocdPos + 12, true);
      const cenOff  = dv.getUint32(eocdPos + 16, true);

      let p = cenOff;
      const end = cenOff + cenSize;

      while (p + 46 <= end && dv.getUint32(p, true) === SIG_CEN) {
        const crc32  = dv.getUint32(p + 16, true);
        const csize  = dv.getUint32(p + 20, true);
        const usize  = dv.getUint32(p + 24, true);
        const fnlen  = dv.getUint16(p + 28, true);
        const xlen   = dv.getUint16(p + 30, true);
        const clen   = dv.getUint16(p + 32, true);
        const lhofs  = dv.getUint32(p + 42, true);

        if (lhofs + 30 <= u8.length && dv.getUint32(lhofs, true) ===  SIG_LOC) {
          const gp = dv.getUint16(lhofs + 6, true);
          dv.setUint16(lhofs + 6, gp & ~0x0008, true); // clear data-descriptor bit (0x0008)
          dv.setUint32(lhofs + 14, crc32, true);
          dv.setUint32(lhofs + 18, csize, true);
          dv.setUint32(lhofs + 22, usize, true);
        }
        p += 46 + fnlen + xlen + clen;
      }
      return u8;
    }


    // ---------- CSV Parser (FIXED) ----------
    const parseCSV = (csvText) => {
      const lines = csvText.split(/\r?\n/);
      let headerRowIndex = -1;
      let headerIndices = {};
      const data = [];
      const newAgentsAvailable = [];
      // FIX: Since 'Avg. Calls/Day' is missing, we must hardcode the total report days.
      // Based on the filter sheet, the report covers 5 days.
      let computedDays = 5; 

      // 1. Find the header row (starting with 'Name')
      for (let i = 0; i < lines.length; i++) {
        if (lines[i].trim().startsWith(AGENT_DATA_START_KEYWORD)) {
          headerRowIndex = i;
          break;
        }
      }
      
      if (headerRowIndex === -1) throw new Error("Could not find the start of the agent data (missing 'Name' column).");

      // 2. Map header names to their column index
      const headers = lines[headerRowIndex].split(',').map(h => h.trim().replace(/"/g, ''));

      REQUIRED_HEADERS.forEach(header => {
        const index = headers.findIndex(h => h === header);
        if (index === -1) {
          throw new Error(`Required column '${header}' not found in the report.`);
        }
        headerIndices[header] = index;
      });

      // 3. Process data rows starting from the row after the header
      for (let r = headerRowIndex + 1; r < lines.length; r++) {
        const line = lines[r].trim();
        if (!line) continue;

        const row = line.split(',');
        // Ensure the row is long enough to contain the last required column
        const maxIndex = Math.max(...Object.values(headerIndices));
        if (row.length <= maxIndex) continue; 

        // Dynamic lookups using the mapped indices
        const agentName = String(row[headerIndices["Name"]] || "").trim().replace(/"/g, '');
        const userStatus = String(row[headerIndices["User Status"]] || "").trim().toUpperCase();

        const totalCalls = parseFloat(row[headerIndices["Total Calls"]]) || 0;
        const totalInboundCount = parseInt(row[headerIndices["# Inbound"]]) || 0;
        const totalOutboundCount = parseInt(row[headerIndices["# Outbound"]]) || 0;

        const totalHandleIn = hmsToSeconds(String(row[headerIndices["Total Handle Time (in)"]] || ""));
        const totalHandleOut = hmsToSeconds(String(row[headerIndices["Total Handle Time (out)"]] || ""));

        if (!agentName || agentName.toUpperCase().includes("DIRECT") || userStatus !== "ACTIVE") continue;

        newAgentsAvailable.push(agentName);

        // FIX: We assume the agent was active for all report days if they have activity.
        let daysActive = computedDays; 
        if (totalCalls === 0) {
          daysActive = 0;
        }

        if (totalHandleIn + totalHandleOut === 0 && totalCalls === 0) continue;

        data.push({
          agentName,
          daysActive,
          totalCalls,
          totalInboundCount,
          totalOutboundCount,
          totalHandleTimeInSecondsIn: totalHandleIn,
          totalHandleTimeInSecondsOut: totalHandleOut,
          totalReportDays: computedDays
        });
      }

      agentsAvailableInFile = Array.from(new Set(newAgentsAvailable)).sort();
      return data;
    };

    const calculateStatistics = (data) => {
      const finalStats = [];
      const filtered = data.filter(a => agentsToDisplay.includes(a.agentName));

      filtered.forEach(agent => {
        const daysActive = agent.daysActive || 1;
        const totalProductive = agent.totalHandleTimeInSecondsIn + agent.totalHandleTimeInSecondsOut;

        const avgInboundCount = agent.totalInboundCount / daysActive;
        const avgOutboundCount = agent.totalOutboundCount / daysActive;
        const avgInboundTime = agent.totalHandleTimeInSecondsIn / daysActive;
        const avgOutboundTime = agent.totalHandleTimeInSecondsOut / daysActive;

        const totalWorkingSeconds = daysActive * WORKING_DAY_SECONDS;
        const totalTimeOffPhone = Math.max(0, totalWorkingSeconds - totalProductive);
        const avgTimeOffPhone = totalTimeOffPhone / daysActive;

        finalStats.push({
          agentName: agent.agentName,
          daysActive,
          avgInboundCount: parseFloat(avgInboundCount.toFixed(1)),
          avgOutboundCount: parseFloat(avgOutboundCount.toFixed(1)),
          avgInboundTime,
          avgOutboundTime,
          avgTimeOffPhone,
          totalReportDays
        });
      });

      if (finalStats.length > 0) {
        const grandDays = finalStats.filter(s => s.daysActive > 0).reduce((s, x) => s + x.daysActive, 0);
        if (grandDays > 0) {
          const teamAvg = {
            agentName: 'TEAM AVERAGE',
            // FIX: daysActive in team average should be the average total days active for all agents
            daysActive: finalStats.filter(s => s.agentName !== 'TEAM AVERAGE').reduce((s, x) => s + x.daysActive, 0),
            totalReportDays,
            // Calculate weighted averages based on total days active per agent
            avgInboundCount: finalStats.reduce((s, x) => s + x.avgInboundCount * x.daysActive, 0) / grandDays,
            avgOutboundCount: finalStats.reduce((s, x) => s + x.avgOutboundCount * x.daysActive, 0) / grandDays,
            avgInboundTime: finalStats.reduce((s, x) => s + x.avgInboundTime * x.daysActive, 0) / grandDays,
            avgOutboundTime: finalStats.reduce((s, x) => s + x.avgOutboundTime * x.daysActive, 0) / grandDays,
            avgTimeOffPhone: finalStats.reduce((s, x) => s + x.avgTimeOffPhone * x.daysActive, 0) / grandDays,
          };
          teamAvg.avgInboundCount = parseFloat(teamAvg.avgInboundCount.toFixed(1));
          teamAvg.avgOutboundCount = parseFloat(teamAvg.avgOutboundCount.toFixed(1));
          finalStats.push(teamAvg);
        }
      }
      return finalStats;
    };

    const populateAgentFilter = () => {
      const container = document.getElementById('checkbox-container');
      container.innerHTML = '';
      agentsAvailableInFile.forEach(agentName => {
        const item = document.createElement('label');
        item.className = 'agent-checkbox-item';
        item.htmlFor = `stat-agent-${agentName.replace(/\s/g, '-')}`;

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `stat-agent-${agentName.replace(/\s/g, '-')}`;
        checkbox.value = agentName;
        checkbox.checked = true;
        checkbox.className = 'mr-2 rounded text-emerald-600 focus:ring-emerald-500';

        item.appendChild(checkbox);
        item.appendChild(document.createTextNode(agentName));
        container.appendChild(item);
      });
      agentsToDisplay = [...agentsAvailableInFile];
    };

    const renderStatistics = () => {
      const tbody = document.getElementById('stats-table-body');
      const summaryDiv = document.getElementById('summary-metrics');
      tbody.innerHTML = '';

      if (agentStatistics.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">No agent data found or no agents selected.</td></tr>';
        summaryDiv.textContent = ``;
        return;
      }

      const teamAvgRow = agentStatistics.find(s => s.agentName === 'TEAM AVERAGE');
      const individuals = agentStatistics.filter(s => s.agentName !== 'TEAM AVERAGE');

      const reportDays = individuals.length > 0 ? individuals[0].totalReportDays : totalReportDays;
      summaryDiv.innerHTML = `Analysis covers ${individuals.length} selected agents based on a RingCentral report covering <span class="font-bold">${reportDays} total day(s)</span>.`;

      const sorted = [...individuals].sort((a,b) => {
        let av = a[sortColumn], bv = b[sortColumn];
        if (typeof av === 'string') { av = av.toLowerCase(); bv = bv.toLowerCase(); }
        if (av < bv) return sortDirection === 'asc' ? -1 : 1;
        if (av > bv) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });

      document.querySelectorAll('.table-header-cell').forEach(th => {
        th.classList.remove('asc', 'desc');
        if (th.getAttribute('data-sort-key') === sortColumn) th.classList.add(sortDirection);
      });

      const fmt = (s) => secondsToHms(s);

      sorted.forEach((stat, i) => {
        const row = document.createElement('tr');
        row.className = `hover:bg-gray-100 ${i % 2 === 1 ? 'bg-gray-50' : 'bg-white'}`;
        const offPhoneClass = stat.avgTimeOffPhone > IDLE_TIME_HIGHLIGHT_THRESHOLD ? 'bg-red-50 text-red-700 font-semibold' : 'text-gray-700';
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${stat.agentName}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stat.daysActive} of ${stat.totalReportDays}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stat.avgInboundCount.toFixed(1)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-emerald-600 font-medium">${fmt(stat.avgInboundTime)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${stat.avgOutboundCount.toFixed(1)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-indigo-600 font-medium">${fmt(stat.avgOutboundTime)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm ${offPhoneClass}">${fmt(stat.avgTimeOffPhone)}</td>
        `;
        tbody.appendChild(row);
      });

      if (teamAvgRow) {
        const row = document.createElement('tr');
        row.className = 'bg-emerald-100 border-t-2 border-emerald-500 hover:bg-emerald-100/80 font-bold';
        // FIX: Display total days active in filter correctly
        const totalDaysActiveInFilter = teamAvgRow.daysActive.toFixed(0); 
        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teamAvgRow.agentName}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${totalDaysActiveInFilter} total days in filter</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${teamAvgRow.avgInboundCount.toFixed(1)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-emerald-700">${fmt(teamAvgRow.avgInboundTime)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${teamAvgRow.avgOutboundCount.toFixed(1)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-indigo-700">${fmt(teamAvgRow.avgOutboundTime)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-red-700">${fmt(teamAvgRow.avgTimeOffPhone)}</td>
        `;
        tbody.appendChild(row);
      }
    };

    // ---------- File handling (Kept as is) ----------
    const handleProcessedCSV = (csvText) => {
      document.getElementById('loading-overlay').style.display = 'flex';
      statusMessage.classList.add('hidden');
      try {
        initialData = parseCSV(csvText);
        if (initialData.length === 0) throw new Error("No active agent data with handle time found.");
        const first = initialData[0];
        totalReportDays = first ? first.totalReportDays : 5; // Default to 5 days if no data

        populateAgentFilter();
        agentStatistics = calculateStatistics(initialData);
        sortColumn = 'agentName';
        sortDirection = 'asc';
        renderStatistics();

        document.getElementById('dashboard-area').style.display = 'block';
        dropText.innerHTML = `✅ <strong>Dashboard Loaded!</strong> Filter agents or drop a new file to refresh.`;
      } catch (err) {
        console.error("Data Processing Error:", err);
        statusMessage.textContent = `Data Extraction Failed: ${err.message}. The safest method is always to use the "Users.csv" sheet.`;
        statusMessage.classList.remove('hidden');
      } finally {
        document.getElementById('loading-overlay').style.display = 'none';
      }
    };

    const handleCSVUpload = (file) => {
      const reader = new FileReader();
      reader.onload = (e) => handleProcessedCSV(e.target.result);
      reader.readAsText(file);
    };

    const handleXLSXUpload = (file) => {
      document.getElementById('loading-overlay').style.display = 'flex';
      statusMessage.classList.add('hidden');
      dropText.textContent = `Reading ${file.name}...`;

      if (!window.XLSX) {
        statusMessage.textContent = "XLSX library not available. Check your connection.";
        statusMessage.classList.remove('hidden');
        document.getElementById('loading-overlay').style.display = 'none';
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const raw = new Uint8Array(e.target.result);
          // Apply the zip normalizer to fix the bad uncompressed size errors
          const fixed = normalizeZipLocalHeaders(raw);

          // Read the workbook from the normalized array
          const wb = XLSX.read(fixed, { type: 'array', dense: true, cellDates: true });
          if (!wb.SheetNames.includes(SHEET_NAME_TO_FIND)) {
            throw new Error(`Workbook does not contain a sheet named "${SHEET_NAME_TO_FIND}".`);
          }
          const ws = wb.Sheets[SHEET_NAME_TO_FIND];

          const csvText = XLSX.utils.sheet_to_csv(ws);
          dropText.innerHTML = `✅ <strong>Users sheet loaded!</strong> Analyzing data...`;

          handleProcessedCSV(csvText);
        } catch (err) {
          console.error("XLSX Read Error:", err);
          statusMessage.textContent = `XLSX Conversion Failed: ${err.message}. Please upload the "Users.csv" sheet.`;
          statusMessage.classList.remove('hidden');
        } finally {
          document.getElementById('loading-overlay').style.display = 'none';
        }
      };
      reader.readAsArrayBuffer(file);
    };

    const handleFileUpload = (file) => {
      const name = file.name.toLowerCase();
      if (name.endsWith('.xlsx') || name.endsWith('.xlsm') || name.endsWith('.xls')) {
        // Must ensure XLSX is loaded before attempting to use it
        if (!window.XLSX) {
            statusMessage.textContent = "XLSX library is still loading or blocked. Please wait a moment or try the CSV file.";
            statusMessage.classList.remove('hidden');
            return;
        }
        handleXLSXUpload(file);
      } else if (name.endsWith('.csv')) {
        handleCSVUpload(file);
      } else {
        statusMessage.textContent = "Invalid file type. Upload the original .xlsx RingCentral report or a Users.csv.";
        statusMessage.classList.remove('hidden');
      }
    };

    // ---------- Rendering and Events (Simplified for clarity) ----------

    const handleAgentFilterChange = () => {
      const checkboxes = document.querySelectorAll('#checkbox-container input[type="checkbox"]');
      agentsToDisplay = [];
      checkboxes.forEach(cb => { if (cb.checked) agentsToDisplay.push(cb.value); });
      agentStatistics = calculateStatistics(initialData);
      renderStatistics();
    };

    const handleClearSelection = () => {
      const checkboxes = document.querySelectorAll('#checkbox-container input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = false);
      handleAgentFilterChange();
    };

    const handleSort = (e) => {
      const newKey = e.currentTarget.getAttribute('data-sort-key');
      if (sortColumn === newKey) sortDirection = (sortDirection === 'asc') ? 'desc' : 'asc';
      else { sortColumn = newKey; sortDirection = 'asc'; }
      agentStatistics = calculateStatistics(initialData);
      renderStatistics();
    };
    
    // (Other rendering/filter functions are standard and left as is)

    const initApp = () => {
      dataFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) handleFileUpload(file);
      });

      ['dragenter','dragover','dragleave','drop'].forEach(evt => {
        dropArea.addEventListener(evt, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
      });
      ['dragenter','dragover'].forEach(evt => {
        dropArea.addEventListener(evt, () => dropArea.classList.add('border-emerald-500'), false);
      });
      ['dragleave','drop'].forEach(evt => {
        dropArea.addEventListener(evt, () => dropArea.classList.remove('border-emerald-500'), false);
      });
      dropArea.addEventListener('drop', (e) => {
        const dt = e.dataTransfer;
        if (dt.files.length) handleFileUpload(dt.files[0]);
      }, false);
      dropArea.addEventListener('click', () => dataFileInput.click());

      document.querySelectorAll('.table-header-cell').forEach(th => th.addEventListener('click', handleSort));
      document.getElementById('applyFilter').addEventListener('click', handleAgentFilterChange);
      document.getElementById('clearSelection').addEventListener('click', handleClearSelection);

      console.log("Stats Dashboard Initialized. Waiting for file...");
    };

    window.addEventListener("load", initApp);
  </script>
