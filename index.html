<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Call Activity Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.4.4/build/global/luxon.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.3.1"></script>
<style>
body {
  font-family: system-ui, sans-serif;
  background: #f7f9fb;
  margin: 0;
  padding: 20px;
}
.container {
  max-width: 1400px;
  margin: 0 auto;
}
h1 {
  text-align: center;
  color: #222;
}
.upload-box {
  border: 2px dashed #ccc;
  border-radius: 10px;
  padding: 30px;
  text-align: center;
  background: #fff;
  margin-bottom: 30px;
}
button {
  background: #2e7d32;
  color: white;
  border: none;
  padding: 10px 25px;
  border-radius: 6px;
  cursor: pointer;
}
button:hover {
  background: #256628;
}
.hidden {
  display: none;
}
.card {
  background: #fff;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.1);
  margin-bottom: 25px;
}
table {
  border-collapse: collapse;
  width: 100%;
}
th, td {
  text-align: left;
  padding: 8px;
}
th {
  background-color: #f3f4f6;
  border-bottom: 2px solid #ddd;
}
tr:nth-child(even) { background-color: #f9f9f9; }
.toggle-btn {
  background: #3949ab;
  color: #fff;
  border: none;
  border-radius: 6px;
  padding: 8px 20px;
  margin-top: 15px;
  cursor: pointer;
}
.toggle-btn:hover { background: #303f9f; }
canvas { width: 100%!important; height: 450px!important; }
</style>
</head>
<body>
<div class="container">
  <h1>Agent Call Activity Dashboard</h1>
  
  <div class="upload-box">
    <h3>Upload RingCentral Reports (.xlsx)</h3>
    <p>Select both <strong>Calls</strong> and <strong>Users</strong> files.</p>
    <input type="file" id="fileInput" multiple accept=".xlsx">
    <p id="fileStatus"></p>
  </div>

  <div id="timelineCard" class="card hidden">
    <h2>Agent Call Timeline</h2>
    <canvas id="timelineChart"></canvas>
  </div>

  <div id="productivityCard" class="card hidden">
    <h2>Daily Productivity Metrics (8-Hour Net)</h2>
    <div id="productivityTable"></div>
  </div>

  <div id="discrepancyCard" class="card hidden">
    <h2>Discrepancies</h2>
    <button class="toggle-btn" onclick="toggleDiscrepancies()">Toggle Discrepancies</button>
    <div id="discrepancyTable" class="hidden"></div>
  </div>
</div>

<script>
let callsData = null, usersData = null;

document.getElementById("fileInput").addEventListener("change", async (e) => {
  const files = e.target.files;
  if (files.length < 2) {
    document.getElementById("fileStatus").innerText = "Please select BOTH Calls and Users reports.";
    return;
  }

  const fileList = Array.from(files);
  let callsFile = fileList.find(f => f.name.toLowerCase().includes("calls"));
  let usersFile = fileList.find(f => f.name.toLowerCase().includes("users"));
  
  if (!callsFile || !usersFile) {
    document.getElementById("fileStatus").innerText = "Files not recognized. Please include 'Calls' and 'Users' in filenames.";
    return;
  }

  document.getElementById("fileStatus").innerText = "Processing reports...";
  
  callsData = await readXLSX(callsFile);
  usersData = await readXLSX(usersFile);

  document.getElementById("fileStatus").innerText = "Files loaded successfully.";
  buildDashboard();
});

async function readXLSX(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = e => {
      const workbook = XLSX.read(e.target.result, {type: "binary"});
      const sheet = workbook.Sheets[workbook.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(sheet, {defval: ""});
      resolve(json);
    };
    reader.onerror = reject;
    reader.readAsBinaryString(file);
  });
}

function buildDashboard() {
  try {
    renderTimeline(callsData);
    renderProductivity(usersData);
    renderDiscrepancies(callsData, usersData);
  } catch (err) {
    console.error("Dashboard build failed:", err);
    document.getElementById("fileStatus").innerText = "Error rendering dashboard.";
  }
}

function renderTimeline(data) {
  const ctx = document.getElementById("timelineChart").getContext("2d");
  document.getElementById("timelineCard").classList.remove("hidden");

  const labels = [...new Set(data.map(d => d["Name"]))];
  const callCounts = labels.map(name => data.filter(d => d["Name"] === name).length);

  new Chart(ctx, {
    type: "bar",
    data: {
      labels: labels,
      datasets: [{
        label: "Total Calls",
        data: callCounts,
        backgroundColor: "rgba(46,125,50,0.7)"
      }]
    },
    options: {
      indexAxis: "y",
      scales: { x: { beginAtZero: true } },
      plugins: { legend: { display: false } }
    }
  });
}

function renderProductivity(data) {
  document.getElementById("productivityCard").classList.remove("hidden");
  const container = document.getElementById("productivityTable");
  let html = "<table><tr><th>Agent Name</th><th>Total Calls</th><th>Total Handle Time</th><th>Avg Handle Time</th></tr>";
  
  data.forEach(row => {
    html += `<tr>
      <td>${row["Name"] || ""}</td>
      <td>${row["Total Calls"] || 0}</td>
      <td>${row["Total Handle Time"] || ""}</td>
      <td>${row["Avg. Handle Time"] || ""}</td>
    </tr>`;
  });
  html += "</table>";
  container.innerHTML = html;
}

function renderDiscrepancies(calls, users) {
  document.getElementById("discrepancyCard").classList.remove("hidden");
  const container = document.getElementById("discrepancyTable");
  
  const callNames = new Set(calls.map(r => r["Name"]));
  const userNames = new Set(users.map(r => r["Name"]));
  
  const missingInUsers = [...callNames].filter(n => !userNames.has(n));
  const missingInCalls = [...userNames].filter(n => !callNames.has(n));

  let html = "<h4>Agents with Mismatched Records</h4><table><tr><th>Missing In</th><th>Agent</th></tr>";
  missingInUsers.forEach(name => html += `<tr><td>Users</td><td>${name}</td></tr>`);
  missingInCalls.forEach(name => html += `<tr><td>Calls</td><td>${name}</td></tr>`);
  html += "</table>";

  container.innerHTML = html;
}

function toggleDiscrepancies() {
  const el = document.getElementById("discrepancyTable");
  el.classList.toggle("hidden");
}
</script>
</body>
</html>
