<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Agent Call Activity Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- SheetJS for XLSX parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Plotly for heatmap -->
  <script src="https://cdn.plot.ly/plotly-2.30.0.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
    body { font-family: 'Inter', sans-serif; background: #f7f9fb; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; box-shadow:0 1px 2px rgba(0,0,0,0.04); }
    .dash-header { border-bottom:4px solid #10b981; }
    .toggle-chevron { transition: transform .2s ease; }
    .collapse[aria-expanded="true"] .toggle-chevron { transform: rotate(90deg); }
  </style>
</head>
<body class="min-h-screen text-gray-900">

  <div class="max-w-7xl mx-auto px-4 py-8">
    <!-- Header -->
    <header class="card dash-header p-6 mb-6">
      <h1 class="text-3xl font-bold">Agent Call Activity Dashboard</h1>
      <p id="date-range-summary" class="text-gray-500 mt-1">
        Upload the Calls and Users XLSX reports to begin.
      </p>
    </header>

    <!-- Single Upload (accept both files at once) -->
    <section class="card p-6 mb-6">
      <h2 class="text-xl font-semibold mb-2">Upload Files (.xlsx)</h2>
      <p class="text-sm text-gray-600 mb-4">
        You can select or drop <strong>both files at once</strong>:
        <span class="text-emerald-700 font-medium">Multi-Day Agent Stats ‚Äî Calls</span> (sheet ‚ÄúCalls‚Äù) and
        <span class="text-indigo-700 font-medium">Multi-Day Agent Stats ‚Äî Users</span> (sheet ‚ÄúUsers‚Äù).
      </p>

      <div id="drop-both" class="border-2 border-dashed rounded-xl p-8 text-center cursor-pointer hover:bg-slate-50">
        <p class="text-gray-700 mb-2">Drag & drop one or two XLSX files, or click to choose</p>
        <input type="file" id="fileBoth" accept=".xlsx,.xls" multiple class="hidden">
        <button id="btnBoth" class="px-4 py-2 rounded-md bg-slate-800 text-white hover:bg-slate-900">Select Files</button>
        <div class="grid md:grid-cols-2 gap-4 mt-4 text-sm">
          <p id="callsStatus" class="text-gray-500">Calls: not loaded</p>
          <p id="usersStatus" class="text-gray-500">Users: not loaded</p>
        </div>
      </div>
    </section>

    <!-- Heatmap -->
    <section id="heatmapCard" class="card p-6 mb-6 hidden">
      <div class="flex items-center justify-between">
        <h2 class="text-2xl font-semibold">üìÖ Heatmap ‚Äî Call Activity by Hour</h2>
        <div class="text-sm text-gray-500" id="heatmapLegend">
          Calls counted when Connected/Answered/Transferred or Outbound ‚â• 5s
        </div>
      </div>
      <div class="mt-4">
        <div id="heatmap" style="width:100%;height:520px;"></div>
      </div>
    </section>

    <!-- Summary -->
    <section id="summaryCard" class="card p-6 mb-6 hidden">
      <h2 class="text-2xl font-semibold mb-4">üìä Daily Productivity Metrics (8-Hour Net)</h2>
      <div class="overflow-x-auto">
        <table class="min-w-full">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Agent</th>
              <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Total Calls</th>
              <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Inbound Time</th>
              <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Outbound Time</th>
              <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Total Talk Time</th>
              <th class="px-4 py-2 text-left text-xs font-semibold text-red-600 uppercase">Time Off Phone (8h)</th>
            </tr>
          </thead>
          <tbody id="summaryBody" class="divide-y divide-gray-100"></tbody>
        </table>
      </div>
    </section>

    <!-- Discrepancies (collapsible, hidden by default) -->
    <section id="diffCard" class="card mb-10 hidden">
      <button id="diffToggle" class="w-full text-left px-6 py-4 flex items-center justify-between">
        <span class="text-xl font-semibold">üîé Show Differences (Calls vs Users)</span>
        <svg class="w-5 h-5 toggle-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/>
        </svg>
      </button>
      <div id="diffPanel" class="px-6 pb-6 hidden">
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Agent</th>
                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Calls (Calls file)</th>
                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Calls (Users file)</th>
                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Œî Calls</th>
                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Talk Time (Calls)</th>
                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Talk Time (Users)</th>
                <th class="px-4 py-2 text-left text-xs font-semibold text-gray-600 uppercase">Œî Talk Time</th>
              </tr>
            </thead>
            <tbody id="diffBody" class="divide-y divide-gray-100"></tbody>
          </table>
        </div>
        <p id="diffEmpty" class="text-sm text-gray-500 mt-3 hidden">
          No meaningful differences detected (within ¬±5% or ‚â§1 call).
        </p>
      </div>
    </section>
  </div>

  <script>
    // ------------------------------
    // CONFIG
    // ------------------------------
    const VALID_RESULTS_CONNECTED = ["Connected", "Answered"];
    const VALID_RESULTS_TRANSFERRED = ["Transferred", "Transferred / To Voicemail"];

    const AGENT_LIST = [
      "ALEJANDRO SATUNINO CAMPOS-PEREZ",
      "AUSTIN MITCHELL",
      "Brady Olson",
      "Brandon Ridder",
      "BRANDON RUSSOM",
      "BRENDAN BOH",
      "Cullen Manley",
      "David Ryan",
      "DOMINIQUE GONZALES",
      "Duncan Cannon",
      "Hayden Holcomb",
      "Joel Jubber",
      "John Udick",
      "KIMBERLY RAMIREZ",
      "MARCOS HERNANDEZ",
      "MOUNIR ROSENDO",
      "Natasha Fowler",
      "Nathan Hill",
      "Olivia Kasten",
      "Tammy Lummus",
      "Wanda Scott"
    ];
    const AGENT_MAP = new Map(AGENT_LIST.map(n => [n.toUpperCase(), n]));
    const DIRECT_ALIAS_MAP = { "NATE": "Nathan Hill" };

    const NET_WORKDAY_SECONDS = 8 * 3600;
    const IDLE_TIME_HIGHLIGHT_SECONDS = 4 * 3600;

    // ------------------------------
    // STATE
    // ------------------------------
    let callsRows = null; // raw rows from Calls sheet
    let usersRows = null; // raw rows from Users sheet
    let callsMetrics = null; // per agent from Calls file
    let usersMetrics = null; // per agent from Users file
    let dateStrings = new Set(); // for header summary

    // ------------------------------
    // HELPERS
    // ------------------------------
    function resetState() {
      callsRows = null;
      usersRows = null;
      callsMetrics = null;
      usersMetrics = null;
      dateStrings = new Set();
      document.getElementById('callsStatus').textContent = 'Calls: not loaded';
      document.getElementById('usersStatus').textContent = 'Users: not loaded';
      document.getElementById('heatmapCard').classList.add('hidden');
      document.getElementById('summaryCard').classList.add('hidden');
      document.getElementById('diffCard').classList.add('hidden');
      document.getElementById('diffPanel').classList.add('hidden');
      document.getElementById('date-range-summary').textContent =
        'Upload the Calls and Users XLSX reports to begin.';
      const heat = document.getElementById('heatmap');
      if (heat) heat.innerHTML = '';
      const body = document.getElementById('summaryBody');
      if (body) body.innerHTML = '';
      const diffBody = document.getElementById('diffBody');
      if (diffBody) diffBody.innerHTML = '';
      document.getElementById('diffEmpty').classList.add('hidden');
    }

    function extractAgentName(fullName) {
      if (!fullName || typeof fullName !== 'string') return null;

      let cleaned = fullName;
      if (cleaned.includes(' - ')) cleaned = cleaned.split(' - ')[0];
      if (cleaned.includes('(')) cleaned = cleaned.split('(')[0];
      cleaned = cleaned.trim();
      if (!cleaned) return null;

      const up = cleaned.toUpperCase();

      // robust direct/contains matching
      for (const [upperTarget, originalName] of AGENT_MAP.entries()) {
        if (up === upperTarget || up.startsWith(upperTarget) || upperTarget.includes(up) || up.includes(upperTarget)) {
          return originalName;
        }
      }

      // "<FirstName> Direct ..."
      const directIdx = up.indexOf(' DIRECT');
      if (directIdx > 0) {
        const before = up.slice(0, directIdx).trim();
        const maybeFirst = before.split(/\s+/).pop() || "";
        if (DIRECT_ALIAS_MAP[maybeFirst]) return DIRECT_ALIAS_MAP[maybeFirst];

        for (const [upperTarget, originalName] of AGENT_MAP.entries()) {
          const first = upperTarget.split(' ')[0];
          if (first === maybeFirst) return originalName;
        }
      }

      // Last-name fallback
      for (const [upperTarget, originalName] of AGENT_MAP.entries()) {
        const last = upperTarget.split(' ').slice(-1)[0];
        if (last && up.includes(last)) return originalName;
      }

      return null;
    }

    function excelDurationToSeconds(val) {
      if (val == null) return 0;

      // Date object (HH:MM:SS time)
      if (val instanceof Date) {
        return val.getHours()*3600 + val.getMinutes()*60 + val.getSeconds();
      }
      // number => Excel day fraction or seconds
      if (typeof val === 'number') {
        if (val > 0 && val < 1) return Math.round(val * 24 * 3600);
        return Math.round(val); // assume already seconds
      }
      // string "HH:MM:SS" or "MM:SS"
      if (typeof val === 'string') {
        const parts = val.split(':').map(x => parseInt(x,10));
        if (parts.length === 3 && parts.every(v=>!Number.isNaN(v))) {
          return parts[0]*3600 + parts[1]*60 + parts[2];
        }
        if (parts.length === 2 && parts.every(v=>!Number.isNaN(v))) {
          return parts[0]*60 + parts[1];
        }
      }
      return 0;
    }

    function formatHMS(sec) {
      sec = Math.round(sec || 0);
      const h = Math.floor(sec/3600);
      const m = Math.floor((sec%3600)/60);
      const s = sec%60;
      return `${h}h ${m}m ${s}s`;
    }

    function parseMaybeDate(val) {
      if (val instanceof Date) return val;
      const d = new Date(val);
      return isNaN(d.getTime()) ? null : d;
    }

    // Users sheet column resolver (flexible names)
    function findUsersColumns(rowKeys) {
      const keys = rowKeys.map(k => String(k).toLowerCase());
      const finder = (cands) => {
        for (const label of cands) {
          const idx = keys.findIndex(k => k.includes(label));
          if (idx >= 0) return rowKeys[idx];
        }
        return null;
      };
      return {
        agent:   finder(['agent','user','name']),
        calls:   finder(['total calls','calls']),
        inTime:  finder(['inbound handle time','inbound talk time','inbound time']),
        outTime: finder(['outbound handle time','outbound talk time','outbound time']),
        totTime: finder(['total productive time','total talk time','productive time','handle time total'])
      };
    }

    // ------------------------------
    // PARSE CALLS FILE ‚Üí metrics + heatmap
    // ------------------------------
    function buildCallsMetrics(rows) {
      const perAgent = {};
      const agentsSet = new Set();

      rows.forEach(r => {
        const from = r["From Name"];
        const to = r["To Name"];
        const result = r["Result"];
        const direction = r["Call Direction"];
        const startRaw = r["Call Start Time"];
        const lengthRaw = r["Call Length"];

        let agent = extractAgentName(from) || extractAgentName(to);
        if (!agent) return;

        const callLen = excelDurationToSeconds(lengthRaw);
        if (!callLen) return;

        let valid = false;
        if (VALID_RESULTS_CONNECTED.includes(result)) valid = true;
        else if (VALID_RESULTS_TRANSFERRED.includes(result)) valid = true;
        else if (direction === 'Outbound' && callLen >= 5) valid = true;
        if (!valid) return;

        const start = parseMaybeDate(startRaw);
        if (!start) return;

        agentsSet.add(agent);
        dateStrings.add(start.toLocaleDateString());

        if (!perAgent[agent]) perAgent[agent] = { calls:0, talkSec:0, inboundSec:0, outboundSec:0 };
        perAgent[agent].calls += 1;
        perAgent[agent].talkSec += callLen;
        if (direction === 'Inbound' || VALID_RESULTS_TRANSFERRED.includes(result)) perAgent[agent].inboundSec += callLen;
        else perAgent[agent].outboundSec += callLen;
      });

      const agents = AGENT_LIST.filter(a => agentsSet.has(a));
      const hours = Array.from({length:24}, (_,i)=>i);
      const z = agents.map(() => Array(24).fill(0));

      // Fill heatmap counts
      rows.forEach(r => {
        const from = r["From Name"];
        const to = r["To Name"];
        const result = r["Result"];
        const direction = r["Call Direction"];
        const startRaw = r["Call Start Time"];
        const lengthRaw = r["Call Length"];

        let agent = extractAgentName(from) || extractAgentName(to);
        if (!agent) return;
        if (!agents.includes(agent)) return;

        const callLen = excelDurationToSeconds(lengthRaw);
        if (!callLen) return;

        let valid = false;
        if (VALID_RESULTS_CONNECTED.includes(result)) valid = true;
        else if (VALID_RESULTS_TRANSFERRED.includes(result)) valid = true;
        else if (direction === 'Outbound' && callLen >= 5) valid = true;
        if (!valid) return;

        const start = parseMaybeDate(startRaw);
        if (!start) return;
        const hour = start.getHours();

        const ai = agents.indexOf(agent);
        z[ai][hour] += 1;
      });

      return { perAgent, heatmap: { agents, hours, z } };
    }

    // ------------------------------
    // PARSE USERS FILE ‚Üí metrics table (truth for summary)
    // ------------------------------
    function buildUsersMetrics(rows) {
      if (!rows || rows.length === 0) return {};
      const colMap = findUsersColumns(Object.keys(rows[0]));

      const perAgent = {};
      rows.forEach(r => {
        const agent = extractAgentName(r[colMap.agent]);
        if (!agent) return;

        const totalCalls = Number(r[colMap.calls]) || 0;
        const inboundSec = excelDurationToSeconds(r[colMap.inTime]);
        const outboundSec = excelDurationToSeconds(r[colMap.outTime]);
        let totalTalk = excelDurationToSeconds(r[colMap.totTime]);
        if (!totalTalk) totalTalk = inboundSec + outboundSec; // fallback

        perAgent[agent] = {
          calls: totalCalls,
          inboundSec,
          outboundSec,
          talkSec: totalTalk
        };
      });
      return perAgent;
    }

    // ------------------------------
    // RENDER: Heatmap
    // ------------------------------
    function renderHeatmap(heat) {
      if (!heat || !heat.agents || heat.agents.length === 0) {
        document.getElementById('heatmapCard').classList.add('hidden');
        return;
      }
      const x = heat.hours.map(h => `${h.toString().padStart(2,'0')}:00`);
      const y = heat.agents;
      const z = heat.z;

      const data = [{
        x, y, z,
        type: 'heatmap',
        colorscale: 'YlGnBu',
        hovertemplate: 'Agent: %{y}<br>Hour: %{x}<br>Calls: %{z}<extra></extra>'
      }];

      const layout = {
        margin: { l: 140, r: 20, t: 10, b: 40 },
        xaxis: { title: 'Hour of Day' },
        yaxis: { title: 'Agent' }
      };

      Plotly.newPlot('heatmap', data, layout, {displayModeBar:false, responsive:true});
      document.getElementById('heatmapCard').classList.remove('hidden');
    }

    // ------------------------------
    // RENDER: Summary (from Users metrics)
    // ------------------------------
    function renderSummary(users) {
      const body = document.getElementById('summaryBody');
      body.innerHTML = '';

      const agents = Object.keys(users).sort((a,b)=>a.localeCompare(b));
      if (agents.length === 0) {
        document.getElementById('summaryCard').classList.add('hidden');
        return;
      }

      agents.forEach(a => {
        const m = users[a];
        const totalTalk = m.talkSec || (m.inboundSec + m.outboundSec);
        const timeOff = Math.max(0, NET_WORKDAY_SECONDS - totalTalk);
        const offClass = timeOff > IDLE_TIME_HIGHLIGHT_SECONDS ? 'text-red-700 font-semibold' : 'text-gray-700';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-4 py-2 text-sm font-medium">${a}</td>
          <td class="px-4 py-2 text-sm">${m.calls}</td>
          <td class="px-4 py-2 text-sm text-emerald-600">${formatHMS(m.inboundSec)}</td>
          <td class="px-4 py-2 text-sm text-indigo-600">${formatHMS(m.outboundSec)}</td>
          <td class="px-4 py-2 text-sm">${formatHMS(totalTalk)}</td>
          <td class="px-4 py-2 text-sm ${offClass}">${formatHMS(timeOff)}</td>
        `;
        body.appendChild(tr);
      });

      document.getElementById('summaryCard').classList.remove('hidden');
    }

    // ------------------------------
    // RENDER: Differences (only rows with diffs) ‚Äî hidden by default
    // ------------------------------
    function renderDiff(calls, users) {
      const diffBody = document.getElementById('diffBody');
      const diffEmpty = document.getElementById('diffEmpty');
      diffBody.innerHTML = '';

      const allAgents = new Set([...Object.keys(calls||{}), ...Object.keys(users||{})]);
      let shown = 0;

      allAgents.forEach(a => {
        const cm = (calls && calls[a]) ? calls[a] : { calls:0, talkSec:0 };
        const um = (users && users[a]) ? users[a] : { calls:0, talkSec:0 };

        const callDelta = (cm.calls||0) - (um.calls||0);
        const timeDelta = (cm.talkSec||0) - (um.talkSec||0);

        const pctCalls = (um.calls ? Math.abs(callDelta)/um.calls : (cm.calls ? 1 : 0));
        const pctTime  = (um.talkSec ? Math.abs(timeDelta)/um.talkSec : (cm.talkSec ? 1 : 0));

        const callsOff = Math.abs(callDelta) > 1 || pctCalls >= 0.05;
        const timeOff  = Math.abs(timeDelta) > 60 || pctTime >= 0.05;

        if (callsOff || timeOff) {
          shown++;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="px-4 py-2 text-sm font-medium">${a}</td>
            <td class="px-4 py-2 text-sm">${cm.calls||0}</td>
            <td class="px-4 py-2 text-sm">${um.calls||0}</td>
            <td class="px-4 py-2 text-sm ${callsOff ? 'text-red-700 font-semibold' : ''}">${callDelta > 0 ? '+' : ''}${callDelta}</td>
            <td class="px-4 py-2 text-sm">${formatHMS(cm.talkSec||0)}</td>
            <td class="px-4 py-2 text-sm">${formatHMS(um.talkSec||0)}</td>
            <td class="px-4 py-2 text-sm ${timeOff ? 'text-red-700 font-semibold' : ''}">
              ${timeDelta>0?'+':''}${formatHMS(Math.abs(timeDelta)).replace(/^/, timeDelta>0?'+':'-').replace('+-','-')}
            </td>
          `;
          diffBody.appendChild(tr);
        }
      });

      if (shown === 0) {
        diffEmpty.classList.remove('hidden');
      } else {
        diffEmpty.classList.add('hidden');
      }
      // Keep the section hidden until manually toggled
      document.getElementById('diffCard').classList.remove('hidden');
      document.getElementById('diffPanel').classList.add('hidden');
      document.getElementById('diffCard').setAttribute('aria-expanded', 'false');
    }

    // ------------------------------
    // BUILD DASHBOARD
    // ------------------------------
    function buildDashboard() {
      if (!callsRows || !usersRows) return;

      const c = buildCallsMetrics(callsRows);
      callsMetrics = c.perAgent;

      usersMetrics = buildUsersMetrics(usersRows);

      // header date summary
      const header = document.getElementById('date-range-summary');
      if (dateStrings.size) {
        header.textContent = `Loaded data for: ${Array.from(dateStrings).sort().join(', ')}.`;
      }

      // render heatmap + summary + diffs
      renderHeatmap(c.heatmap);
      renderSummary(usersMetrics);
      renderDiff(callsMetrics, usersMetrics);
    }

    // ------------------------------
    // FILE LOADING (single area, multi-file)
    // ------------------------------
    function handleWorkbook(file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = e => {
          try {
            const data = new Uint8Array(e.target.result);
            const wb = XLSX.read(data, { type: 'array' });

            // If a workbook contains both sheets, we can populate both in one file.
            // Otherwise, populate whichever exists.
            const callsSheet = wb.Sheets['Calls'];
            const usersSheet = wb.Sheets['Users'];

            if (callsSheet) {
              const rows = XLSX.utils.sheet_to_json(callsSheet, { defval: '' });
              callsRows = rows; // last one wins if multiple provided (expected same day)
              document.getElementById('callsStatus').textContent =
                `Calls: ${file.name} (${rows.length} rows)`;
            }
            if (usersSheet) {
              const rows = XLSX.utils.sheet_to_json(usersSheet, { defval: '' });
              usersRows = rows;
              document.getElementById('usersStatus').textContent =
                `Users: ${file.name} (${rows.length} rows)`;
            }

            // Fallback: if sheet names differ, try first sheet as type hint by header presence
            if (!callsSheet || !usersSheet) {
              const first = wb.Sheets[wb.SheetNames[0]];
              const headers = XLSX.utils.sheet_to_json(first, { header:1 })[0] || [];
              const headerStr = headers.map(h=>String(h||'').toLowerCase()).join('|');

              // Heuristics
              const looksLikeCalls = /from name|to name|call start time|call length|result|call direction/.test(headerStr);
              const looksLikeUsers = /total calls|inbound|outbound|handle time|talk time/.test(headerStr);

              if (!callsSheet && looksLikeCalls) {
                const rows = XLSX.utils.sheet_to_json(first, { defval: '' });
                callsRows = rows;
                document.getElementById('callsStatus').textContent =
                  `Calls: ${file.name} (${rows.length} rows)`;
              }
              if (!usersSheet && looksLikeUsers) {
                const rows = XLSX.utils.sheet_to_json(first, { defval: '' });
                usersRows = rows;
                document.getElementById('usersStatus').textContent =
                  `Users: ${file.name} (${rows.length} rows)`;
              }
            }

          } catch (err) {
            console.error('Failed reading', file.name, err);
          } finally {
            resolve();
          }
        };
        reader.readAsArrayBuffer(file);
      });
    }

    async function handleFiles(fileList) {
      // Start fresh each time the user selects/drops
      resetState();

      const files = Array.from(fileList || []);
      if (files.length === 0) return;

      // Read all provided workbooks
      for (const f of files) {
        await handleWorkbook(f);
      }

      // Auto-build if both are present
      if (callsRows && usersRows) {
        buildDashboard();
      } else {
        // If either is missing, tell the user which one
        if (!callsRows) {
          document.getElementById('callsStatus').textContent =
            'Calls: missing (please include the Calls file with sheet "Calls")';
        }
        if (!usersRows) {
          document.getElementById('usersStatus').textContent =
            'Users: missing (please include the Users file with sheet "Users")';
        }
      }
    }

    function wireSingleDrop() {
      const zone = document.getElementById('drop-both');
      const input = document.getElementById('fileBoth');
      const btn = document.getElementById('btnBoth');

      btn.addEventListener('click', () => input.click());
      input.addEventListener('change', e => handleFiles(e.target.files));

      ['dragenter','dragover','dragleave','drop'].forEach(ev => {
        zone.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); }, false);
      });
      zone.addEventListener('drop', e => {
        const files = e.dataTransfer.files;
        handleFiles(files);
      });
      zone.addEventListener('click', () => input.click());
    }

    // ------------------------------
    // COLLAPSE TOGGLE (differences)
    // ------------------------------
    function wireCollapse() {
      const toggle = document.getElementById('diffToggle');
      const panel = document.getElementById('diffPanel');
      const container = document.getElementById('diffCard');
      toggle.addEventListener('click', () => {
        const open = !panel.classList.contains('hidden');
        if (open) panel.classList.add('hidden');
        else panel.classList.remove('hidden');
        container.setAttribute('aria-expanded', (!open).toString());
      });
    }

    // ------------------------------
    // INIT
    // ------------------------------
    (function init(){
      wireSingleDrop();
      wireCollapse();
    })();
  </script>
</body>
</html>
